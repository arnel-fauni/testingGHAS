name: Code Scanning Alerts to Slack

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Real Vulnerability Details
        env:
          GH_TOKEN: ${{ github.token }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          ALERTS=$(gh api /repos/${{ github.repository }}/code-scanning/alerts?state=open \
            --jq '.alerts[] | "*üö® \(.rule.severity|upcase) - \(.rule.rule_id)*\nüìÅ \(.most_recent_instance.location.path):\(.most_recent_instance.location.start_line)\nüí° \(.rule.description)\nüîó \(.html_url)\n" | join("\n\n")')
          
          if [ "$ALERTS" != "null" ] && [ -n "$ALERTS" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"text\": \":rotating_light: **GITHUB ADVANCED SECURITY ALERTS** :rotating_light:\n*Repo:* ${{ github.repository }}\n\n$ALERTS\"
              }" $SLACK_WEBHOOK_URL
          else
            echo "No open alerts found"
          fi
