name: Code Scanning Alerts to Slack
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Real Vulnerabilities
        env:
          GH_TOKEN: ${{ github.token }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          ALERTS=$(gh api /repos/${{ github.repository }}/code-scanning/alerts?state=open \
            --jq '.alerts[] | "*ðŸš¨ \(.rule.severity|upcase) - \(.rule.rule_id)*\nðŸ“ \(.most_recent_instance.location.path):\(.most_recent_instance.location.start_line)\nðŸ’¡ \(.rule.description)\nðŸ”— \(.html_url)\n" | join("\n\n")' 2>/dev/null || echo "")
          
          [ -n "$ALERTS" ] && curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\":rotating_light: **GITHUB ADVANCED SECURITY ALERTS** :rotating_light:\n*Repo:* ${{ github.repository }}\n\n$ALERTS\"}" "$SLACK_WEBHOOK_URL"
