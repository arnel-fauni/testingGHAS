name: Code Scanning Alerts to Slack

on:
  schedule:
    - cron: '*/15 * * * *'  # Check every 15 minutes
  workflow_dispatch:  # Manual trigger option

permissions:
  security-events: write

jobs:
  check-alerts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: List recent code scanning alerts
        id: alerts
        run: |
          ALERTS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/code-scanning/alerts \
            --jq '[.alerts[] | select(.state == "open") | {id: .id, rule: .rule.rule_id, severity: .rule.severity, file: .most_recent_instance.location.path, line: .most_recent_instance.location.start_line, url: .html_url}] | length')
          echo "alert_count=$ALERTS" >> $GITHUB_OUTPUT
      
      - name: Send Slack notification if new alerts
        if: steps.alerts.outputs.alert_count > 0
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          channel-id: 'C018YG5J7TP'  # Your channel ID
          slack-message: |
            ðŸš¨ *New Code Scanning Alerts* ðŸš¨
            **Repo:** ${{ github.repository }}
            **Count:** ${{ steps.alerts.outputs.alert_count }}
            **Check Security tab:** ${{ github.repository }}/security/code-scanning
