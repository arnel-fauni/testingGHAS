name: Code Scanning Alerts to Slack Workflow

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours (UTC)
  workflow_dispatch:  # Manual trigger

permissions:
  security-events: read

jobs:
  check-alerts:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch code scanning alerts
        id: alerts
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.codeScanning.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 10
            });
            
            const alerts = response.data.map(alert => ({
              id: alert.id,
              severity: alert.most_recent_instance.rule.severity,
              message: alert.most_recent_instance.message?.text?.slice(0, 200) || 'No message',
              rule: alert.most_recent_instance.rule.id,
              location: alert.most_recent_instance.location?.path || 'Unknown',
              url: alert.html_url
            }));
            
            core.set_output('alerts_json', JSON.stringify(alerts));
            core.set_output('alert_count', alerts.length);
            console.log(`Found ${alerts.length} open alerts`);

      - name: Trigger Slack Workflow
        if: steps.alerts.outputs.alert_count != '0'
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WORKFLOW_WEBHOOK_URL }}
        with:
          webhook-type: webhook-trigger
          payload: |
            {
              "repo": "${{ github.repository }}",
              "alert_count": ${{ steps.alerts.outputs.alert_count }},
              "alerts": ${{ steps.alerts.outputs.alerts_json }},
              "timestamp": "${{ github.run_id }}"
            }
