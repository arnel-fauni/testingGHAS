name: Code Scanning Alerts to Slack

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

permissions:
  security-events: write
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Fetch & format alerts
        id: alerts
        run: |
          ALERTS=$(gh api \
            /repos/${{ github.repository }}/code-scanning/alerts?state=open \
            --jq '.alerts[] | "- **ðŸš¨ ' + .rule.severity + '** ' + .rule.rule_id + '\n  ðŸ“„ *' + (.most_recent_instance.location.path // "N/A") + ":" + ((.most_recent_instance.location.start_line|tostring) // "N/A") + '*\n  ðŸ’¡ ' + (.rule.description // "No description") + '\n  ðŸ”— <' + .html_url + '|View Alert>"' \
            | tr -d '"' | paste -sd '\n' -)
          
          echo "alerts<<EOF" >> $GITHUB_OUTPUT
          echo "$ALERTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Send detailed alerts to Slack
        if: steps.alerts.outputs.alerts != ''
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          channel-id: 'C018YG5J7TP'
          slack-message: |
            :rotating_light: **NEW GITHUB ADVANCED SECURITY ALERTS** :rotating_light:
            *Repository:* ${{ github.repository }}
            
            ${{ steps.alerts.outputs.alerts }}
            
            :mag: *Check all alerts:* https://github.com/${{ github.repository }}/security/code-scanning
